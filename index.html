<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Prueba Árbol</title>
  <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.2/dist/aframe-extras.min.js"></script>
</head>

<body style="margin:0; overflow:hidden;">

  <a-scene
    background="color: #7F7F7FFF"
    renderer="antialias: true; colorManagement: true; physicallyCorrectLights: true"
    shadow="type: pcfsoft">

    <!-- Assets -->
    <a-assets>
      <a-asset-item id="tronco" src="assets/tronco.glb"></a-asset-item>
      <a-asset-item id="ramas" src="assets/ramas.glb"></a-asset-item>
      <a-asset-item id="hongos" src="assets/hongos.glb"></a-asset-item>
      <a-asset-item id="tlacuache" src="assets/tlacuache.glb"></a-asset-item>
    </a-assets>

    <!-- Modelos -->
    <a-entity gltf-model="#tronco"
              position="0 0 -3"
              scale="1 1 1">
    </a-entity>

    <a-entity gltf-model="#ramas"
              position="0 0 -3"
              scale="1 1 1">
    </a-entity>

    <a-entity gltf-model="#hongos"
              position="0 0 -3"
              scale="1 1 1">
    </a-entity>

    <!-- Cámara y tlacuache -->
<a-entity id="rig"
  movement-controls="controls: keyboard, nipple; speed: 0.06; acceleration: 20;"
  position="0 0 0">

  <!-- TLACUACHE -->
  <a-entity id="player"
            gltf-model="#tlacuache"
            position="0 0 0"
            animation-mixer="clip: walk; loop: repeat">
  </a-entity>

  <!-- CÁMARA -->
<a-entity id="cameraPivot" position="0 1.5 0" rotation="0 0 0">
  <a-entity id="cameraBoom" position="0 1 4">
    <a-entity id="gameCamera" camera></a-entity>
  </a-entity>
</a-entity>

</a-entity>

  </a-scene>

<script>
window.addEventListener('load', () => {

  const scene = document.querySelector('a-scene');

  scene.addEventListener('loaded', () => {

    const rig = document.querySelector('#rig');
    const player = document.querySelector('#player');
    const pivot = document.querySelector('#cameraPivot');

    /* --------------------------
       ROTACIÓN DEL PERSONAJE
    ---------------------------*/

    let lastPosition = new THREE.Vector3();
    let moving = false;

    function angleDifference(a, b) {
      let diff = b - a;
      return Math.atan2(Math.sin(diff), Math.cos(diff));
    }

    player.addEventListener('model-loaded', () => {

      player.components['animation-mixer'].pause();
      rig.object3D.getWorldPosition(lastPosition);

      function tick() {

        const currentPosition = new THREE.Vector3();
        rig.object3D.getWorldPosition(currentPosition);

        const direction = new THREE.Vector3().subVectors(currentPosition, lastPosition);
        const distance = direction.length();

        if (distance > 0.0001) {

          const moveAngle = Math.atan2(direction.x, direction.z);
          const targetRotation = moveAngle + Math.PI;

          const currentRotation = player.object3D.rotation.y;
          const diff = angleDifference(currentRotation, targetRotation);

          player.object3D.rotation.y += diff * 0.15;

          if (!moving) {
            player.components['animation-mixer'].play();
            moving = true;
          }

        } else if (moving) {

          player.components['animation-mixer'].pause();
          moving = false;
        }

        lastPosition.copy(currentPosition);
        requestAnimationFrame(tick);
      }

      tick();
    });

    /* --------------------------
       CÁMARA ORBITAL REAL
    ---------------------------*/

    let isDragging = false;
    let previousX = 0;
    let previousY = 0;

    let yaw = 0;
    let pitch = 0;

    const sensitivity = 0.25;
    const pitchLimit = 60;

    function rotateCamera(deltaX, deltaY) {

      yaw -= deltaX * sensitivity;
      pitch -= deltaY * sensitivity;

      pitch = Math.max(-pitchLimit, Math.min(pitchLimit, pitch));

      pivot.object3D.rotation.y = THREE.MathUtils.degToRad(yaw);
      pivot.object3D.rotation.x = THREE.MathUtils.degToRad(pitch);
    }

    /* Mouse */
    window.addEventListener('mousedown', e => {
      isDragging = true;
      previousX = e.clientX;
      previousY = e.clientY;
    });

    window.addEventListener('mouseup', () => isDragging = false);

    window.addEventListener('mousemove', e => {
      if (!isDragging) return;
      rotateCamera(e.clientX - previousX, e.clientY - previousY);
      previousX = e.clientX;
      previousY = e.clientY;
    });

    /* Touch */
    window.addEventListener('touchstart', e => {
      if (e.touches.length !== 1) return;
      isDragging = true;
      previousX = e.touches[0].clientX;
      previousY = e.touches[0].clientY;
    });

    window.addEventListener('touchend', () => isDragging = false);

    window.addEventListener('touchmove', e => {
      if (!isDragging || e.touches.length !== 1) return;
      rotateCamera(
        e.touches[0].clientX - previousX,
        e.touches[0].clientY - previousY
      );
      previousX = e.touches[0].clientX;
      previousY = e.touches[0].clientY;
    });

  });

});
</script>
  
</body>

</html>
