<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Prueba √Årbol</title>
  <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.2/dist/aframe-extras.min.js"></script>
</head>

<body style="margin:0; overflow:hidden;">

  <a-scene
    background="color: #7F7F7FFF"
    renderer="antialias: true; colorManagement: true; physicallyCorrectLights: true"
    shadow="type: pcfsoft">

    <!-- Assets -->
    <a-assets>
      <a-asset-item id="tronco" src="assets/tronco.glb"></a-asset-item>
      <a-asset-item id="ramas" src="assets/ramas.glb"></a-asset-item>
      <a-asset-item id="hongos" src="assets/hongos.glb"></a-asset-item>
      <a-asset-item id="tlacuache" src="assets/tlacuache.glb"></a-asset-item>
    </a-assets>

    <!-- Modelos -->
    <a-entity gltf-model="#tronco"
              position="0 0 -3"
              scale="1 1 1">
    </a-entity>

    <a-entity gltf-model="#ramas"
              position="0 0 -3"
              scale="1 1 1">
    </a-entity>

    <a-entity gltf-model="#hongos"
              position="0 0 -3"
              scale="1 1 1">
    </a-entity>

    <!-- C√°mara y tlacuache -->
<a-entity id="rig"
  nipple-controls="mode: static"
  position="0 0 0">

  <!-- TLACUACHE -->
  <a-entity id="player"
            gltf-model="#tlacuache"
            position="0 0 0"
            animation-mixer="clip: walk; loop: repeat">
  </a-entity>

  <!-- C√ÅMARA -->
<a-entity id="cameraPivot" position="0 1.5 0">

  <a-entity id="cameraYaw" look-controls="pointerLockEnabled: false">

    <a-entity id="cameraBoom" position="0 1 4">
      <a-entity camera></a-entity>
    </a-entity>

</a-entity>

  </a-scene>

<script>
document.addEventListener('DOMContentLoaded', () => {

  const rig = document.querySelector('#rig');
  const player = document.querySelector('#player');
  const camera = document.querySelector('#gameCamera');

  const speed = 4;
  const rotationSmooth = 0.15;

  let keys = {};
  let nippleVector = new THREE.Vector2(0, 0);
  let lastTime = performance.now();
  let moving = false;

  function angleDifference(a, b) {
    let diff = b - a;
    return Math.atan2(Math.sin(diff), Math.cos(diff));
  }

  /* ==============================
     KEYBOARD INPUT
  ============================== */

  window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
  window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

  /* ==============================
     NIPPLE INPUT
  ============================== */

  rig.addEventListener('nipplemove', (evt) => {
    const data = evt.detail;
    nippleVector.set(data.vector.x, data.vector.y);
  });

  rig.addEventListener('nippleend', () => {
    nippleVector.set(0, 0);
  });

  /* ==============================
     ANIMATION INIT
  ============================== */

  player.addEventListener('model-loaded', () => {
    player.components['animation-mixer']?.pause();
  });

  /* ==============================
     MAIN LOOP
  ============================== */

  function tick() {

    const now = performance.now();
    const delta = (now - lastTime) / 1000;
    lastTime = now;

    const input = new THREE.Vector2(0, 0);

    // keyboard
    if (keys['w']) input.y -= 1;
    if (keys['s']) input.y += 1;
    if (keys['a']) input.x -= 1;
    if (keys['d']) input.x += 1;

    // nipple
    input.x += nippleVector.x;
    input.y -= nippleVector.y;

    if (input.length() > 0) {

      input.normalize();

      // üî• obtener forward de c√°mara
      const forward = new THREE.Vector3();
      camera.object3D.getWorldDirection(forward);
      forward.y = 0;
      forward.normalize();

      const right = new THREE.Vector3();
      right.crossVectors(forward, new THREE.Vector3(0,1,0)).normalize();

      const moveVector = new THREE.Vector3();
      moveVector.addScaledVector(forward, -input.y);
      moveVector.addScaledVector(right, input.x);

      rig.object3D.position.addScaledVector(moveVector, speed * delta);

      // rotar personaje hacia movimiento
      const moveAngle = Math.atan2(moveVector.x, moveVector.z);
      const targetRotation = moveAngle + Math.PI;

      const currentRotation = player.object3D.rotation.y;
      const diff = angleDifference(currentRotation, targetRotation);

      player.object3D.rotation.y += diff * rotationSmooth;

      if (!moving) {
        player.components['animation-mixer']?.play();
        moving = true;
      }

    } else {
      if (moving) {
        player.components['animation-mixer']?.pause();
        moving = false;
      }
    }

    requestAnimationFrame(tick);
  }

  tick();
});
</script>
  
</body>

</html>






